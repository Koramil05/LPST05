<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Formatter Laporan Harian Koramil 1609-05/Sukasada">
    <title>Laporan Koramil 1609-05/Sukasada</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --whatsapp: #25D366;
            --sheets: #34A853;
            --cloud: #3498db;
            --drive: #4285F4;
        }
        
        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Noto Sans', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 80px;
        }
        
        /* ========== STATUS INDICATORS ========== */
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 999;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sync-status {
            position: fixed;
            top: 50px;
            right: 15px;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 998;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .synced {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .unsynced {
            background: #fff3cd;
            color: #856404;
        }
        
        /* ========== HEADER ========== */
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .header h2 {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: normal;
        }
        
        /* ========== MAIN LAYOUT ========== */
        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .form-container, .preview-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        
        .preview-container {
            display: flex;
            flex-direction: column;
        }
        
        /* ========== SECTION TITLES ========== */
        .section-title {
            color: var(--primary);
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-controls {
            display: flex;
            gap: 8px;
        }
        
        /* ========== FORM INPUTS ========== */
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* ========== TEXTAREA STYLES ========== */
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            font-size: 13px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: Arial, Helvetica, sans-serif;
            resize: vertical;
        }
        
        .auto-resize {
            min-height: 70px;
            line-height: 1.5;
            resize: none;
            overflow: hidden;
        }
        
        /* ========== PREVIEW TEXTAREA ========== */
        .preview-textarea {
            min-height: 400px;
            padding: 15px;
            border: 2px solid #000000;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
            line-height: 1.6;
            background: #ffffff !important;
            color: #000000 !important;
            resize: none;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-weight: 500;
        }
        
        .situasi-preview {
            background-color: #f8f9fa;
            border: 2px solid #e1e8ed;
            padding: 15px;
            margin-top: 8px;
            font-size: 13px;
            line-height: 1.5;
            color: #555;
            white-space: pre-wrap;
            border-radius: 8px;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        .periode-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #d1e8ff 100%);
            border: 2px solid var(--secondary);
            padding: 12px 15px;
            margin-top: 10px;
            font-size: 13px;
            color: var(--primary);
            border-radius: 8px;
        }
        
        /* ========== DATA SIAP OPS GRID ========== */
        .data-siap-ops-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .data-item {
            display: flex;
            flex-direction: column;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 8px;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }
        
        .data-item:focus-within {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .data-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
            text-align: center;
            line-height: 1.2;
        }
        
        .data-input {
            padding: 6px 8px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            width: 100%;
            background: #f8f9fa;
        }
        
        /* ========== KEGIATAN CONTAINER ========== */
        .kegiatan-container {
            margin-bottom: 25px;
        }
        
        .kegiatan-box {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .kegiatan-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 12px;
        }
        
        .kegiatan-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
            flex-grow: 1;
        }
        
        .add-kegiatan-btn {
            background: var(--success);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
        }
        
        .add-kegiatan-btn:hover {
            background: #219653;
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
        }
        
        .kegiatan-content {
            margin-top: 15px;
        }
        
        /* ========== KEGIATAN ITEMS ========== */
        .kegiatan-item {
            position: relative;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .kegiatan-textarea-rounded {
            min-height: 90px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
            background: #f8f9fa;
            resize: none;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            transition: all 0.3s;
        }
        
        .kegiatan-textarea-rounded:focus {
            background: white;
            border-color: var(--secondary);
        }
        
        .item-controls {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .item-control-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            color: white;
        }
        
        .item-add-btn {
            background: var(--success);
        }
        
        .item-remove-btn {
            background: var(--danger);
        }
        
        /* ========== MAIN ACTION BUTTONS ========== */
        .save-cloud-btn {
            background: linear-gradient(135deg, var(--cloud) 0%, var(--sheets) 100%) !important;
            color: white;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            transition: all 0.4s;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .save-cloud-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(52, 152, 219, 0.4);
        }
        
        .send-report-btn {
            background: linear-gradient(135deg, var(--whatsapp) 0%, #2ecc71 100%) !important;
            color: white;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            transition: all 0.4s;
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .send-report-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(37, 211, 102, 0.4);
        }
        
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* ========== ACTION BUTTONS GRID ========== */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .save-btn { background: var(--sheets); color: white; }
        .whatsapp-btn { background: var(--whatsapp); color: white; }
        .export-btn { background: #6c757d; color: white; }
        .reset-btn { background: var(--danger); color: white; }
        .print-btn { background: #17a2b8; color: white; }
        .history-btn { background: #9b59b6; color: white; }
        .cloud-btn { background: var(--cloud); color: white; }
        .drive-btn { background: var(--drive); color: white; }
        
        /* ========== MESSAGES ========== */
        .messages-container {
            margin-bottom: 20px;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.5s ease;
            border-left: 5px solid;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #27ae60;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #e74c3c;
        }
        
        .message-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #f39c12;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #3498db;
        }
        
        .message-icon {
            font-size: 20px;
        }
        
        /* ========== PROGRESS STEPS ========== */
        .progress-steps {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e1e8ed;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: white;
        }
        
        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            background: #eee;
            color: #666;
        }
        
        .step.active .step-icon {
            background: var(--secondary);
            color: white;
        }
        
        .step.completed .step-icon {
            background: var(--success);
            color: white;
        }
        
        .step.failed .step-icon {
            background: var(--danger);
            color: white;
        }
        
        .step-info {
            flex-grow: 1;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .step-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlide 0.4s ease;
        }
        
        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 2px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* ========== TXT FILE ITEM ========== */
        .txt-file-item {
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .txt-file-item:hover {
            border-color: var(--drive);
            background: #e8f0fe;
        }
        
        .txt-file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .txt-file-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }
        
        .txt-file-date {
            font-size: 12px;
            color: #666;
        }
        
        .txt-file-content {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            background: white;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        
        .txt-file-actions {
            display: flex;
            gap: 8px;
        }
        
        .txt-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .load-btn {
            background: var(--success);
            color: white;
        }
        
        .download-btn {
            background: var(--drive);
            color: white;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .form-container,
            .preview-container {
                padding: 15px;
            }
            
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .save-cloud-btn,
            .send-report-btn {
                padding: 16px;
                font-size: 14px;
            }
            
            .kegiatan-textarea-rounded {
                padding-right: 50px;
            }
            
            .item-controls {
                right: 5px;
                top: 5px;
            }
            
            .txt-file-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .txt-file-actions {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .data-siap-ops-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .data-item {
                min-height: 65px;
                padding: 6px;
            }
            
            .data-label {
                font-size: 10px;
            }
            
            .data-input {
                padding: 5px 6px;
                font-size: 12px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        /* ========== UTILITY CLASSES ========== */
        .toggle-section {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }
        
        .toggle-section:hover {
            background: #2980b9;
        }
        
        .dual-button-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        
        @media (max-width: 768px) {
            .dual-button-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* ========== LOADING SPINNER ========== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ========== CONNECTION STATUS ========== -->
    <div id="connectionStatus" class="connection-status online">
        <span id="statusIcon">üåê</span>
        <span id="statusText">Online</span>
    </div>
    
    <!-- ========== SYNC STATUS ========== -->
    <div id="syncStatus" class="sync-status synced" style="display: none;">
        <span id="syncIcon">üîÑ</span>
        <span id="syncText">Data tersimpan</span>
    </div>
    
    <!-- ========== HEADER ========== -->
    <div class="header">
        <h1>
            LAPORAN HARIAN KORAMIL 1609-05/Sukasada
        </h1>
        <h2>Jl. Jelantik Gingsir 32 Sukasada Bali</h2>
        <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
            <span>üì± PWA Web App</span> ‚Ä¢ 
            <span>‚òÅÔ∏è Cloud Sync</span> ‚Ä¢ 
            <span>üìÅ Drive TXT</span> ‚Ä¢ 
            <span>üîÑ Real-time Update</span>
        </div>
        <div id="cloudStatus" style="margin-top: 5px; font-size: 11px; color: var(--success);"></div>
    </div>
    
    <!-- ========== MAIN CONTAINER ========== -->
    <div class="main-container">
        <!-- ========== FORM INPUT ========== -->
        <div class="form-container">
            <h3 class="section-title">
                <span>üìù INPUT DATA LAPORAN</span>
                <div class="section-controls">
                    <button onclick="showLoadFromCloudDialog()" title="Panggil data dari Cloud" class="cloud-btn" style="border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        ‚òÅÔ∏è Panggil Data
                    </button>
                    <button onclick="showTxtFilesModal()" title="File TXT di Drive" class="drive-btn" style="border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        üìÅ File TXT
                    </button>
                </div>
            </h3>
            
            <!-- Waktu Laporan -->
            <div class="input-group">
                <label><span>üìÖ</span> WAKTU LAPORAN</label>
                <div class="input-row">
                    <div>
                        <input type="date" id="reportDate" oninput="autoGenerateReport()">
                    </div>
                    <div>
                        <select id="reportTime" onchange="autoGenerateReport(); updatePeriodeInfo()">
                            <option value="pagi">Pagi (04.00 WITA)</option>
                            <option value="sore">Sore (16.00 WITA)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div id="customTimeContainer" style="display: none;">
                        <input type="time" id="customTime" onchange="updateCustomTime()">
                    </div>
                </div>
                <div class="periode-info" id="periodeInfo" style="display: none;">
                    <strong>Periode Laporan:</strong><br>
                    ‚Ä¢ Pagi 04.00 WITA: Laporan situasi pagi<br>
                    ‚Ä¢ Sore 16.00 WITA: Laporan situasi sore (04.00-16.00 WITA)
                </div>
                <button class="toggle-section" onclick="toggleElement('periodeInfo')">üìå Info Periode</button>
            </div>
            
            <!-- Situasi & Haljol -->
            <div class="input-group">
                <label><span>üìç</span> SITUASI DAN HALJOL</label>
                <div style="margin-bottom: 12px;">
                    <div class="situasi-preview" id="situasiPreview">
                        Pilih tanggal dan waktu untuk generate situasi
                    </div>
                </div>
                <div>
                    <input type="text" id="haljol" value="Nihil" 
                           oninput="checkExcessSpaces('haljol'); autoGenerateReport()" placeholder="Haljol (contoh: Nihil)">
                </div>
            </div>
            
            <!-- DATA SIAP OPS -->
            <div class="input-group">
                <label><span>üìä</span> DATA SIAP OPS</label>
                <div class="data-siap-ops-grid">
                    <div class="data-item">
                        <div class="data-label">Top DSPP</div>
                        <input type="number" id="topDspp" class="data-input" value="25" oninput="calculateSiapOps()">
                    </div>
                    <div class="data-item">
                        <div class="data-label">Nyata</div>
                        <input type="number" id="nyata" class="data-input" value="19" oninput="calculateSiapOps()">
                    </div>
                    <div class="data-item">
                        <div class="data-label">Kurang</div>
                        <input type="number" id="kurang" class="data-input" value="0" oninput="calculateSiapOps()">
                    </div>
                    <div class="data-item">
                        <div class="data-label">Siap Ops</div>
                        <input type="number" id="siapOps" class="data-input" value="19" readonly>
                    </div>
                </div>
            </div>
            
            <!-- KETERANGAN -->
            <div class="input-group">
                <label><span>üìã</span> KETERANGAN</label>
                <div>
                    <textarea class="auto-resize" id="keterangan"
                              onkeydown="handleKeteranganKeydown(event)"
                              oninput="updateKurangFromKeterangan(); autoGenerateReport()">-DD : 0
-BP : 0
-Sakit : 0
-Ijin : 0
-Cuti : 0
-Dinas Luar : 0</textarea>
                </div>
            </div>
            
            <!-- KEGIATAN -->
            <div class="input-group">
                <label><span>üèÉ‚Äç‚ôÇÔ∏è</span> KEGIATAN</label>
                
                <!-- Kegiatan Danramil -->
                <div class="kegiatan-container">
                    <div class="kegiatan-box">
                        <div class="kegiatan-header">
                            <div class="kegiatan-title">Danramil</div>
                            <button class="add-kegiatan-btn" onclick="addKegiatanItem('danramil')">+</button>
                        </div>
                        <div class="kegiatan-content" id="danramil-container"></div>
                    </div>
                </div>
                
                <!-- Kegiatan Koramil -->
                <div class="kegiatan-container">
                    <div class="kegiatan-box">
                        <div class="kegiatan-header">
                            <div class="kegiatan-title">Koramil</div>
                            <button class="add-kegiatan-btn" onclick="addKegiatanItem('koramil')">+</button>
                        </div>
                        <div class="kegiatan-content" id="koramil-container"></div>
                    </div>
                </div>
                
                <!-- Kegiatan Babinsa -->
                <div class="kegiatan-container">
                    <div class="kegiatan-box">
                        <div class="kegiatan-header">
                            <div class="kegiatan-title">Babinsa</div>
                            <button class="add-kegiatan-btn" onclick="addKegiatanItem('babinsa')">+</button>
                        </div>
                        <div class="kegiatan-content" id="babinsa-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== PREVIEW OUTPUT ========== -->
        <div class="preview-container">
            <h3 class="section-title">
                <span>üëÅÔ∏è PREVIEW LAPORAN</span>
                <div class="section-controls">
                    <button onclick="toggleAutoGenerate()" id="autoToggle" title="Auto-generate" style="background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">‚ü≥ ON</button>
                </div>
            </h3>
            
            <!-- Messages -->
            <div id="messagesContainer" class="messages-container"></div>
            
            <!-- Preview -->
            <textarea id="output" class="preview-textarea" placeholder="Laporan akan muncul di sini..."
                      oninput="autoResize(this)"></textarea>
            
            <!-- Progress Steps -->
            <div id="progressSteps" class="progress-steps" style="display: none;">
                <div class="step" id="step1">
                    <div class="step-icon">1</div>
                    <div class="step-info">
                        <div class="step-title">Validasi Data</div>
                        <div class="step-desc">Memeriksa kelengkapan form</div>
                    </div>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon">2</div>
                    <div class="step-info">
                        <div class="step-title">Menyimpan ke Cloud</div>
                        <div class="step-desc">Mengirim ke Google Sheets</div>
                    </div>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">3</div>
                    <div class="step-info">
                        <div class="step-title">Menyiapkan WhatsApp</div>
                        <div class="step-desc">Membuka aplikasi WhatsApp</div>
                    </div>
                </div>
                <div class="step" id="step4">
                    <div class="step-icon">4</div>
                    <div class="step-info">
                        <div class="step-title">Download File</div>
                        <div class="step-desc">Menyimpan ke file TXT</div>
                    </div>
                </div>
            </div>
            <button class="toggle-section" onclick="toggleElement('progressSteps')">üìä Tampilkan Progress</button>
            
            <!-- ========== DUAL BUTTON CONTAINER ========== -->
            <div class="dual-button-container">
                <!-- Tombol Simpan (CLOUD ONLY) -->
                <button class="save-cloud-btn" onclick="saveToCloudOnly()">
                    <div class="btn-icons">
                        <span>üíæ</span>
                        <span>‚òÅÔ∏è</span>
                    </div>
                    SIMPAN KE CLOUD
                    <div class="progress-bar" id="saveCloudProgress"></div>
                </button>
                
                <!-- Tombol Kirim (CLOUD + WhatsApp) -->
                <button class="send-report-btn" onclick="sendCombinedReport()">
                    <div class="btn-icons">
                        <span>üì±</span>
                        <span>üì§</span>
                    </div>
                    KIRIM LAPORAN
                    <div class="progress-bar" id="sendReportProgress"></div>
                </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn save-btn" onclick="saveToCloudOnly()">
                    <span>üíæ</span> Simpan
                </button>
                <button class="action-btn whatsapp-btn" onclick="sendCombinedReport()">
                    <span>üì±</span> Kirim
                </button>
                <button class="action-btn export-btn" onclick="exportToTxt()">
                    <span>üì•</span> Export
                </button>
                <button class="action-btn reset-btn" onclick="resetForm()">
                    <span>üîÑ</span> Reset
                </button>
                <button class="action-btn print-btn" onclick="printReport()">
                    <span>üñ®Ô∏è</span> Print
                </button>
                <button class="action-btn cloud-btn" onclick="showLoadFromCloudDialog()">
                    <span>‚òÅÔ∏è</span> Panggil
                </button>
                <button class="action-btn drive-btn" onclick="showTxtFilesModal()">
                    <span>üìÅ</span> File TXT
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== MODAL CLOUD LOAD ========== -->
    <div id="cloudLoadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;">‚òÅÔ∏è Panggil Data dari Cloud</h3>
                <button onclick="closeModal('cloudLoadModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <div id="cloudDataList">
                    <p style="text-align: center; color: #666; padding: 20px;">Memuat data dari cloud...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="loadLastCloudData()" style="background: var(--cloud); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                    üìÇ Panggil Data Terakhir
                </button>
                <button onclick="closeModal('cloudLoadModal')" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- ========== MODAL TXT FILES ========== -->
    <div id="txtFilesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;">üìÅ File TXT di Google Drive</h3>
                <button onclick="closeModal('txtFilesModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <div id="txtFilesList">
                    <p style="text-align: center; color: #666; padding: 20px;">Memuat file dari Google Drive...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="uploadTxtToDrive()" style="background: var(--drive); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <span>üì§</span> Unggah File Baru
                </button>
                <button onclick="closeModal('txtFilesModal')" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- ========== MODAL VIEW TXT CONTENT ========== -->
    <div id="viewTxtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;" id="viewTxtTitle">üìÑ Isi File TXT</h3>
                <button onclick="closeModal('viewTxtModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <textarea id="txtContentPreview" style="width: 100%; height: 400px; font-family: monospace; font-size: 13px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: none;"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="loadToPreview()" style="background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                    üìã Muat ke Preview
                </button>
                <button onclick="closeModal('viewTxtModal')" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- ========== JAVASCRIPT ========== -->
    <script>
        // ========== GLOBAL VARIABLES ==========
        const kegiatanTypes = ['danramil', 'koramil', 'babinsa'];
        let autoGenerateEnabled = true;
        
        // ========== CONFIGURATION ==========
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz9Gy5TsJ3V4AzMdz-Y3SeJk443YFHfQ5pbPUzVj8Mym0vTW5kIzBi73tZRZbsc7hdSMA/exec';
        const API_KEY = 'koramil2024@secure';
        
        // ========== SYSTEM FUNCTIONS ==========
        function initForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('reportTime').value = 'pagi';
            
            // Initialize kegiatan containers
            kegiatanTypes.forEach(type => {
                addInitialKegiatanItem(type);
            });
            
            // Set initial values
            setTimeout(() => {
                document.getElementById('koramil-0').value = '2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.';
                document.getElementById('danramil-0').value = 'Melaksanakan monitoring perkembangan situasi dan kondisi wilayah Kecamatan Sukasada Kabupaten Buleleng.';
                document.getElementById('babinsa-0').value = 'Melaksanakan pemantauan dan pendataan situasi wilayah desa binaan masing-masing.';
                
                // Auto-resize semua textarea
                document.querySelectorAll('.auto-resize').forEach(textarea => {
                    autoResize(textarea);
                });
            }, 100);
            
            calculateSiapOps();
            updatePeriodeInfo();
            autoGenerateReport();
            
            // Test cloud connection on startup
            setTimeout(() => {
                testCloudConnection();
            }, 2000);
        }
        
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            
            if (navigator.onLine) {
                statusEl.className = 'connection-status online';
                statusText.textContent = 'Online';
                statusIcon.textContent = 'üåê';
            } else {
                statusEl.className = 'connection-status offline';
                statusText.textContent = 'Offline';
                statusIcon.textContent = 'üì¥';
            }
        }
        
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();
        
        // ========== CLOUD CONNECTION TEST ==========
        async function testCloudConnection() {
            try {
                const url = `${GOOGLE_SCRIPT_URL}?action=test&apiKey=${encodeURIComponent(API_KEY)}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('cloudStatus').innerHTML = '‚úÖ Cloud terhubung';
                        return true;
                    }
                }
            } catch (error) {
                console.log('Cloud test failed:', error);
            }
            
            document.getElementById('cloudStatus').innerHTML = '‚ö†Ô∏è Cloud tidak terhubung';
            return false;
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function toggleElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function updateSyncStatus(synced = true) {
            const syncStatus = document.getElementById('syncStatus');
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            
            if (synced) {
                syncStatus.className = 'sync-status synced';
                syncIcon.textContent = '‚úÖ';
                syncText.textContent = 'Data tersimpan';
            } else {
                syncStatus.className = 'sync-status unsynced';
                syncIcon.textContent = 'üîÑ';
                syncText.textContent = 'Menunggu sync';
            }
            
            syncStatus.style.display = 'block';
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ========== KEGIATAN FUNCTIONS ==========
        function addInitialKegiatanItem(type) {
            const container = document.getElementById(`${type}-container`);
            const itemId = `${type}-0`;
            
            const itemHTML = `
                <div class="kegiatan-item" id="${itemId}-container">
                    <div class="item-controls">
                        <button type="button" class="item-control-btn item-add-btn" onclick="addKegiatanItem('${type}')">+</button>
                        <button type="button" class="item-control-btn item-remove-btn" onclick="removeKegiatanItem('${itemId}')">-</button>
                    </div>
                    <textarea class="kegiatan-textarea-rounded auto-resize" 
                              id="${itemId}"
                              placeholder="Tulis kegiatan ${type}..."
                              oninput="autoResize(this); autoGenerateReport()"></textarea>
                </div>
            `;
            
            container.innerHTML = itemHTML;
        }
        
        function addKegiatanItem(type) {
            const container = document.getElementById(`${type}-container`);
            const itemCount = container.querySelectorAll('.kegiatan-item').length;
            const itemId = `${type}-${itemCount}`;
            
            const itemHTML = `
                <div class="kegiatan-item" id="${itemId}-container">
                    <div class="item-controls">
                        <button type="button" class="item-control-btn item-add-btn" onclick="addKegiatanItem('${type}')">+</button>
                        <button type="button" class="item-control-btn item-remove-btn" onclick="removeKegiatanItem('${itemId}')">-</button>
                    </div>
                    <textarea class="kegiatan-textarea-rounded auto-resize" 
                              id="${itemId}"
                              placeholder="Tulis kegiatan ${type} tambahan..."
                              oninput="autoResize(this); autoGenerateReport()"></textarea>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHTML);
            autoResize(document.getElementById(itemId));
        }
        
        function removeKegiatanItem(itemId) {
            const container = document.getElementById(`${itemId}-container`);
            if (container) {
                container.remove();
                const type = itemId.split('-')[0];
                const items = document.querySelectorAll(`#${type}-container .kegiatan-item`);
                items.forEach((item, index) => {
                    const textarea = item.querySelector('textarea');
                    const newId = `${type}-${index}`;
                    textarea.id = newId;
                    item.id = `${newId}-container`;
                });
            }
        }
        
        // ========== FORM CALCULATIONS ==========
        function updateCustomTime() {
            const customTime = document.getElementById('customTime').value;
            if (customTime) {
                const timeParts = customTime.split(':');
                const formattedTime = `${timeParts[0]}.${timeParts[1]}`;
                document.getElementById('reportTime').value = 'custom';
                document.getElementById('reportTime').dataset.custom = formattedTime;
                autoGenerateReport();
            }
        }
        
        function toggleAutoGenerate() {
            autoGenerateEnabled = !autoGenerateEnabled;
            const button = document.getElementById('autoToggle');
            button.textContent = autoGenerateEnabled ? '‚ü≥ ON' : '‚ü≥ OFF';
            button.style.background = autoGenerateEnabled ? '#27ae60' : '#e74c3c';
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        function calculateSiapOps() {
            const topDspp = parseInt(document.getElementById('topDspp').value) || 0;
            const nyata = parseInt(document.getElementById('nyata').value) || 0;
            const kurang = parseInt(document.getElementById('kurang').value) || 0;
            const siapOps = nyata - kurang;
            document.getElementById('siapOps').value = siapOps > 0 ? siapOps : 0;
        }
        
        function updateKurangFromKeterangan() {
            const keterangan = document.getElementById('keterangan').value;
            const lines = keterangan.split('\n');
            let total = 0;
            
            lines.forEach(line => {
                if (line.includes(':')) {
                    const parts = line.split(':');
                    if (parts.length > 1) {
                        const value = parseInt(parts[1].trim()) || 0;
                        total += value;
                    }
                }
            });
            
            document.getElementById('kurang').value = total;
            calculateSiapOps();
        }
        
        // ========== FORM HANDLING ==========
        function handleKeteranganKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const cursorPos = event.target.selectionStart;
                const textBefore = event.target.value.substring(0, cursorPos);
                const textAfter = event.target.value.substring(cursorPos);
                
                const lines = textBefore.split('\n');
                const currentLine = lines[lines.length - 1];
                
                if (currentLine.trim().startsWith('-')) {
                    event.target.value = textBefore + '\n-' + textAfter;
                } else {
                    event.target.value = textBefore + '\n-' + textAfter;
                }
                
                const newPos = cursorPos + 2;
                event.target.selectionStart = event.target.selectionEnd = newPos;
                
                event.target.dispatchEvent(new Event('input'));
            }
        }
        
        function checkExcessSpaces(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = field.value.replace(/\s+/g, ' ').trim();
            }
        }
        
        // ========== DATE & TIME FUNCTIONS ==========
        function generateSituasiText() {
            const dateInput = document.getElementById('reportDate').value;
            const timeSelect = document.getElementById('reportTime');
            const timeValue = timeSelect.value;
            
            if (!dateInput) return 'Pilih tanggal terlebih dahulu';
            
            const reportDate = new Date(dateInput);
            const dateInfo = formatDateIndonesia(reportDate);
            
            if (timeValue === 'pagi') {
                // Format Pagi: Hari ini Pukul 04.00 WITA
                return `Pagi :\n-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${dateInfo.hari} Tanggal ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul 04.00 Wita dalam keadaan Aman dan Kondusif`;
            } else if (timeValue === 'sore') {
                // Format Sore: Hari ini Pukul 04.00 s.d 16.00 WITA
                return `Sore :\n-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${dateInfo.hari} Tanggal ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul 04.00 Wita s.d Pukul 16.00 Wita dalam keadaan Aman dan Kondusif`;
            } else if (timeValue === 'custom') {
                const customTime = timeSelect.dataset.custom || '00.00';
                return `Custom ${customTime} WITA :\n-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${dateInfo.hari} Tanggal ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul ${customTime} Wita dalam keadaan Aman dan Kondusif`;
            }
            return '';
        }
        
        function updatePeriodeInfo() {
            const timeSelect = document.getElementById('reportTime');
            const customContainer = document.getElementById('customTimeContainer');
            
            if (timeSelect.value === 'custom') {
                customContainer.style.display = 'block';
            } else {
                customContainer.style.display = 'none';
            }
            
            const situasiPreview = document.getElementById('situasiPreview');
            situasiPreview.textContent = generateSituasiText();
        }
        
        function formatDateIndonesia(date) {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            return {
                hari: days[date.getDay()],
                tanggal: date.getDate(),
                bulan: months[date.getMonth()],
                tahun: date.getFullYear()
            };
        }
        
        // ========== KEGIATAN DATA COLLECTION ==========
        function collectKegiatanData(type) {
            const container = document.getElementById(`${type}-container`);
            const textareas = container.querySelectorAll('textarea');
            const items = [];
            textareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    items.push(textarea.value.trim());
                }
            });
            return items;
        }
        
        // ========== REPORT GENERATION (FIXED FORMAT) ==========
        function generateReport() {
            if (!autoGenerateEnabled) return;
            try {
                const reportDate = new Date(document.getElementById('reportDate').value);
                const timeSelect = document.getElementById('reportTime');
                const timeValue = timeSelect.value;
                const reportTime = timeValue === 'pagi' ? '04.00' : 
                                  timeValue === 'sore' ? '16.00' : 
                                  timeSelect.dataset.custom || '00.00';
                
                const haljol = document.getElementById('haljol').value || 'Nihil';
                const topDspp = document.getElementById('topDspp').value;
                const nyata = document.getElementById('nyata').value;
                const kurang = document.getElementById('kurang').value;
                const siapOps = document.getElementById('siapOps').value;
                const keterangan = document.getElementById('keterangan').value;
                const dateInfo = formatDateIndonesia(reportDate);
                const situasiText = generateSituasiText();
                
                // Tentukan salam berdasarkan waktu
                let waktuSalam = timeValue === 'pagi' ? 'Pagi' : 'Sore';
                
                let report = `Perihal : Laporan perkembangan situasi Koramil 1609-05/Sukasada Hari ${dateInfo.hari} Tanggal, ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun}.\n\n`;
                report += `Yth. Komandan Kodim 1609/Buleleng.\n`;
                report += `Cc. Kasdim 1609/Buleleng.\n\n`;
                report += `Selamat ${waktuSalam}, Mohon ijin melaporkan Situasi Satuan Koramil 1609-05/Sukasada Hari ${dateInfo.hari} Tanggal, ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul ${reportTime} Wita dalam rangka kegiatan Pembinaan Kekuatan Satuan Bulan ${dateInfo.bulan} tahun ${dateInfo.tahun} sebagai berikut :\n\n`;
                report += `*I. Situasi dan Haljol :*\n\n`;
                
                // Format situasi sesuai permintaan
                if (timeValue === 'pagi') {
                    report += `Pagi :\n`;
                    report += `-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${dateInfo.hari} Tanggal ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul 04.00 Wita dalam keadaan Aman dan Kondusif\n\n`;
                } else if (timeValue === 'sore') {
                    report += `Sore :\n`;
                    report += `-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${dateInfo.hari} Tanggal ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul 04.00 Wita s.d Pukul 16.00 Wita dalam keadaan Aman dan Kondusif\n\n`;
                } else {
                    const customTime = timeSelect.dataset.custom || '00.00';
                    report += `Custom ${customTime} WITA :\n`;
                    report += `-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${dateInfo.hari} Tanggal ${dateInfo.tanggal} ${dateInfo.bulan} ${dateInfo.tahun} Pukul ${customTime} Wita dalam keadaan Aman dan Kondusif\n\n`;
                }
                
                report += `-Haljol : ${haljol}.\n\n`;
                report += `*II. Data Siap Ops :*\n\n`;
                report += `1. Top DSPP : ${topDspp}\n`;
                report += `2. Nyata : ${nyata}\n`;
                report += `3. Kurang : ${kurang}\n`;
                report += `4. Siap Ops : ${siapOps}\n\n`;
                report += `5. Keterangan :\n\n`;
                
                keterangan.split('\n').forEach(line => {
                    report += `${line}\n`;
                });
                
                report += `\n*III. Kegiatan :*\n\n`;
                
                // Kegiatan Danramil
                report += `*1. Kegiatan Danramil :*\n\n`;
                const danramilItems = collectKegiatanData('danramil');
                if (danramilItems.length > 0) {
                    danramilItems.forEach(item => {
                        report += `-${item}\n`;
                    });
                } else {
                    report += `-Melaksanakan monitoring perkembangan situasi dan kondisi wilayah Kecamatan Sukasada Kabupaten Buleleng.\n`;
                }
                report += `\n`;
                
                // Kegiatan Koramil
                report += `*2. Kegiatan Koramil :*\n\n`;
                const koramilItems = collectKegiatanData('koramil');
                if (koramilItems.length > 0) {
                    koramilItems.forEach(item => {
                        report += `-${item}\n`;
                    });
                } else {
                    report += `2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.\n`;
                }
                report += `\n`;
                
                // Kegiatan Babinsa
                report += `*3. Kegiatan Babinsa :*\n\n`;
                const babinsaItems = collectKegiatanData('babinsa');
                if (babinsaItems.length > 0) {
                    babinsaItems.forEach(item => {
                        report += `-${item}\n`;
                    });
                } else {
                    report += `-Melaksanakan pemantauan dan pendataan situasi wilayah desa binaan masing-masing.\n`;
                }
                report += `\n`;
                
                report += `*DEMIKIAN MMP.*\n`;
                report += `Dokumentasi terlampir.`;
                
                document.getElementById('output').value = report;
                autoResize(document.getElementById('output'));
                
            } catch (error) {
                console.error('Error generating report:', error);
            }
        }
        
        let autoGenerateTimer;
        function autoGenerateReport() {
            clearTimeout(autoGenerateTimer);
            autoGenerateTimer = setTimeout(generateReport, 500);
        }
        
        // ========== MESSAGE SYSTEM ==========
        function showMessage(type, text, duration = 5000) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageId = 'msg-' + Date.now();
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const message = document.createElement('div');
            message.id = messageId;
            message.className = `message message-${type}`;
            message.innerHTML = `
                <span class="message-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                <span>${text}</span>
            `;
            
            messagesContainer.insertBefore(message, messagesContainer.firstChild);
            
            if (duration > 0) {
                setTimeout(() => {
                    const msg = document.getElementById(messageId);
                    if (msg) {
                        msg.style.opacity = '0';
                        msg.style.transition = 'opacity 0.3s';
                        setTimeout(() => {
                            if (msg.parentNode) msg.parentNode.removeChild(msg);
                        }, 300);
                    }
                }, duration);
            }
            
            return messageId;
        }
        
        // ========== FORM VALIDATION ==========
        function validateForm() {
            const errors = [];
            
            if (!document.getElementById('reportDate').value) {
                errors.push('Tanggal laporan harus diisi');
            }
            
            if (!document.getElementById('haljol').value.trim()) {
                errors.push('Haljol harus diisi');
            }
            
            const totalKegiatan = kegiatanTypes.reduce((total, type) => {
                const items = collectKegiatanData(type);
                return total + items.length;
            }, 0);
            
            if (totalKegiatan === 0) {
                errors.push('Minimal isi satu kegiatan');
            }
            
            return errors;
        }
        
        // ========== CLOUD FUNCTIONS ==========
        async function saveToCloudOnly() {
            const errors = validateForm();
            if (errors.length > 0) {
                showMessage('error', 'Perbaiki kesalahan sebelum menyimpan:<br>' + errors.join('<br>'));
                return false;
            }
            
            const saveProgress = document.getElementById('saveCloudProgress');
            if (saveProgress) {
                saveProgress.style.width = '30%';
            }
            
            try {
                showMessage('info', 'Menyimpan ke Google Sheets...');
                
                const reportText = document.getElementById('output').value;
                const timeSelect = document.getElementById('reportTime');
                const timeValue = timeSelect.value;
                const reportTime = timeValue === 'pagi' ? '04.00' : 
                                  timeValue === 'sore' ? '16.00' : 
                                  timeSelect.dataset.custom || '00.00';
                
                const formData = {
                    action: 'save',
                    apiKey: API_KEY,
                    timestamp: new Date().toISOString(),
                    reportDate: document.getElementById('reportDate').value,
                    reportTime: reportTime, // Kirim waktu dalam format 04.00/16.00
                    haljol: document.getElementById('haljol').value,
                    topDspp: document.getElementById('topDspp').value,
                    nyata: document.getElementById('nyata').value,
                    kurang: document.getElementById('kurang').value,
                    siapOps: document.getElementById('siapOps').value,
                    keterangan: document.getElementById('keterangan').value,
                    kegiatanDanramil: collectKegiatanData('danramil').join(' || '),
                    kegiatanKoramil: collectKegiatanData('koramil').join(' || '),
                    kegiatanBabinsa: collectKegiatanData('babinsa').join(' || '),
                    fullReport: reportText,
                    source: 'Koramil PWA Web App',
                    username: 'Operator'
                };
                
                if (saveProgress) saveProgress.style.width = '60%';
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (saveProgress) saveProgress.style.width = '90%';
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        if (saveProgress) {
                            saveProgress.style.width = '100%';
                            setTimeout(() => {
                                saveProgress.style.width = '0%';
                            }, 1000);
                        }
                        
                        const saveId = 'save-' + Date.now();
                        const cloudSaveData = {
                            id: saveId,
                            timestamp: new Date().toISOString(),
                            reportDate: formData.reportDate,
                            reportTime: formData.reportTime,
                            status: 'cloud_saved'
                        };
                        
                        const cloudSaves = JSON.parse(localStorage.getItem('koramil_cloud_saves') || '[]');
                        cloudSaves.unshift(cloudSaveData);
                        
                        if (cloudSaves.length > 20) {
                            cloudSaves.pop();
                        }
                        
                        localStorage.setItem('koramil_cloud_saves', JSON.stringify(cloudSaves));
                        localStorage.setItem('koramil_last_cloud_save', JSON.stringify(cloudSaveData));
                        
                        updateSyncStatus(true);
                        showMessage('success', '‚úÖ Data berhasil disimpan ke Google Sheets<br>ID: ' + result.reportId);
                        return true;
                    } else {
                        throw new Error(result.error || 'Gagal menyimpan ke cloud');
                    }
                } else {
                    throw new Error('Network error saat menyimpan ke cloud');
                }
            } catch (error) {
                console.error('Cloud save error:', error);
                
                if (saveProgress) {
                    saveProgress.style.width = '0%';
                }
                
                showMessage('error', '‚ùå Gagal menyimpan ke cloud. Silakan coba lagi.');
                updateSyncStatus(false);
                return false;
            }
        }
        
        async function sendCombinedReport() {
            const errors = validateForm();
            if (errors.length > 0) {
                showMessage('error', 'Perbaiki kesalahan sebelum mengirim:<br>' + errors.join('<br>'));
                return;
            }
            
            const progressSteps = document.getElementById('progressSteps');
            const sendProgress = document.getElementById('sendReportProgress');
            
            progressSteps.style.display = 'block';
            if (sendProgress) sendProgress.style.width = '25%';
            
            try {
                document.getElementById('step1').className = 'step active';
                
                document.getElementById('step2').className = 'step active';
                if (sendProgress) sendProgress.style.width = '50%';
                
                const saved = await saveToCloudOnly();
                
                if (saved) {
                    document.getElementById('step2').className = 'step completed';
                    if (sendProgress) sendProgress.style.width = '75%';
                } else {
                    document.getElementById('step2').className = 'step failed';
                    showMessage('warning', 'Gagal menyimpan ke cloud, lanjut ke WhatsApp...');
                }
                
                document.getElementById('step3').className = 'step active';
                setTimeout(() => {
                    sendToWhatsApp();
                    document.getElementById('step3').className = 'step completed';
                    if (sendProgress) sendProgress.style.width = '100%';
                }, 1000);
                
                document.getElementById('step4').className = 'step active';
                setTimeout(() => {
                    exportToTxt();
                    document.getElementById('step4').className = 'step completed';
                    
                    if (sendProgress) {
                        setTimeout(() => {
                            sendProgress.style.width = '0%';
                        }, 1000);
                    }
                    
                    showMessage('success', '‚úÖ Laporan berhasil dikirim dan diunduh!');
                    
                    setTimeout(() => {
                        progressSteps.style.display = 'none';
                    }, 3000);
                }, 2000);
                
            } catch (error) {
                showMessage('error', '‚ùå Terjadi kesalahan: ' + error.message);
                
                if (sendProgress) {
                    sendProgress.style.width = '0%';
                }
            }
        }
        
        // ========== TXT FILE FUNCTIONS FOR GOOGLE DRIVE ==========
        
        async function showTxtFilesModal() {
            showModal('txtFilesModal');
            showMessage('info', 'Memuat daftar file TXT dari Google Drive...');
            
            try {
                const formData = {
                    action: 'listTxtFiles',
                    apiKey: API_KEY
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const txtFilesList = document.getElementById('txtFilesList');
                    
                    if (result.success && result.files && result.files.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">';
                        
                        result.files.forEach((file, index) => {
                            const fileDate = new Date(file.createdTime).toLocaleDateString('id-ID');
                            const fileTime = new Date(file.createdTime).toLocaleTimeString('id-ID', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            const previewContent = file.content ? 
                                (file.content.substring(0, 200) + (file.content.length > 200 ? '...' : '')) : 
                                'Tidak ada preview';
                            
                            html += `
                                <div class="txt-file-item" id="txt-file-${file.id}">
                                    <div class="txt-file-header">
                                        <div class="txt-file-name">${file.name}</div>
                                        <div class="txt-file-date">${fileDate} ${fileTime}</div>
                                    </div>
                                    <div class="txt-file-content">
                                        ${previewContent}
                                    </div>
                                    <div class="txt-file-actions">
                                        <button class="txt-action-btn load-btn" onclick="viewTxtFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">
                                            <span>üëÅÔ∏è</span> Lihat
                                        </button>
                                        <button class="txt-action-btn download-btn" onclick="downloadTxtFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">
                                            <span>üì•</span> Download
                                        </button>
                                        <button class="txt-action-btn load-btn" onclick="loadTxtToPreview('${file.id}')">
                                            <span>üìã</span> Muat
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        txtFilesList.innerHTML = html;
                        
                        showMessage('success', `‚úÖ ${result.files.length} file TXT ditemukan`);
                        
                    } else {
                        txtFilesList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Tidak ada file TXT di Google Drive</p>';
                        showMessage('info', 'Tidak ada file TXT tersimpan di Google Drive');
                    }
                } else {
                    txtFilesList.innerHTML = 
                        '<p style="text-align: center; color: #e74c3c; padding: 20px;">Gagal mengambil file dari Drive</p>';
                    showMessage('error', 'Gagal menghubungi Google Drive');
                }
            } catch (error) {
                console.error('Error loading txt files:', error);
                document.getElementById('txtFilesList').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error: ' + error.message + '</p>';
                showMessage('error', 'Koneksi ke Google Drive gagal: ' + error.message);
            }
        }
        
        async function uploadTxtToDrive() {
            const reportText = document.getElementById('output').value;
            if (!reportText.trim()) {
                showMessage('error', 'Tidak ada laporan untuk disimpan ke Drive');
                return false;
            }
            
            try {
                showMessage('info', 'Menyimpan file TXT ke Google Drive...');
                
                // Generate filename
                const date = new Date(document.getElementById('reportDate').value);
                const timeSelect = document.getElementById('reportTime');
                const timeValue = timeSelect.value;
                const dateStr = date.toISOString().split('T')[0].replace(/-/g, '');
                const timeStr = timeValue === 'pagi' ? '0400' : 
                              timeValue === 'sore' ? '1600' : 
                              'custom';
                const filename = `LAPORAN_KORAMIL_${dateStr}_${timeStr}.txt`;
                
                const formData = {
                    action: 'uploadTxtToDrive',
                    apiKey: API_KEY,
                    filename: filename,
                    content: reportText,
                    reportDate: document.getElementById('reportDate').value,
                    reportTime: timeValue === 'pagi' ? '04.00' : 
                               timeValue === 'sore' ? '16.00' : 
                               timeSelect.dataset.custom || '00.00',
                    timestamp: new Date().toISOString(),
                    source: 'Koramil PWA Web App'
                };
                
                console.log('Upload data:', formData);
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage('success', `‚úÖ File TXT berhasil disimpan ke Drive<br>File: ${filename}<br>ID: ${result.fileId}`);
                        
                        // Simpan metadata di localStorage
                        const driveSaves = JSON.parse(localStorage.getItem('koramil_drive_saves') || '[]');
                        driveSaves.unshift({
                            id: result.fileId,
                            filename: filename,
                            timestamp: new Date().toISOString(),
                            reportDate: formData.reportDate,
                            reportTime: formData.reportTime
                        });
                        
                        if (driveSaves.length > 20) {
                            driveSaves.pop();
                        }
                        
                        localStorage.setItem('koramil_drive_saves', JSON.stringify(driveSaves));
                        
                        // Refresh file list
                        showTxtFilesModal();
                        return true;
                    } else {
                        throw new Error(result.error || 'Gagal menyimpan ke Drive');
                    }
                } else {
                    throw new Error('Network error saat menyimpan ke Drive');
                }
            } catch (error) {
                console.error('Drive save error:', error);
                showMessage('error', '‚ùå Gagal menyimpan ke Drive. Silakan coba lagi.');
                return false;
            }
        }
        
        async function viewTxtFile(fileId, fileName) {
            try {
                showMessage('info', 'Memuat isi file...');
                
                const formData = {
                    action: 'getTxtFile',
                    apiKey: API_KEY,
                    fileId: fileId
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.content) {
                        document.getElementById('viewTxtTitle').textContent = `üìÑ ${fileName}`;
                        document.getElementById('txtContentPreview').value = result.content;
                        document.getElementById('txtContentPreview').dataset.fileId = fileId;
                        document.getElementById('txtContentPreview').dataset.fileName = fileName;
                        
                        closeModal('txtFilesModal');
                        showModal('viewTxtModal');
                        
                        showMessage('success', '‚úÖ File berhasil dimuat');
                    } else {
                        showMessage('error', result.error || 'Gagal memuat isi file');
                    }
                } else {
                    showMessage('error', 'Gagal mengambil isi file');
                }
            } catch (error) {
                console.error('Error viewing txt file:', error);
                showMessage('error', '‚ùå Gagal memuat file: ' + error.message);
            }
        }
        
        async function loadTxtToPreview(fileId) {
            try {
                showMessage('info', 'Memuat file ke preview...');
                
                const formData = {
                    action: 'getTxtFile',
                    apiKey: API_KEY,
                    fileId: fileId
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.content) {
                        // Muat langsung ke preview
                        document.getElementById('output').value = result.content;
                        autoResize(document.getElementById('output'));
                        
                        // Tutup modal
                        closeModal('txtFilesModal');
                        
                        showMessage('success', '‚úÖ File TXT berhasil dimuat ke preview');
                        
                        // Coba parse data dari laporan untuk mengisi form
                        parseReportToForm(result.content);
                    } else {
                        showMessage('error', result.error || 'Gagal memuat file');
                    }
                } else {
                    showMessage('error', 'Gagal mengambil file');
                }
            } catch (error) {
                console.error('Error loading txt to preview:', error);
                showMessage('error', '‚ùå Gagal memuat file: ' + error.message);
            }
        }
        
        function loadToPreview() {
            const content = document.getElementById('txtContentPreview').value;
            if (content.trim()) {
                document.getElementById('output').value = content;
                autoResize(document.getElementById('output'));
                closeModal('viewTxtModal');
                showMessage('success', '‚úÖ Konten berhasil dimuat ke preview');
                
                // Coba parse data dari laporan
                parseReportToForm(content);
            }
        }
        
        async function downloadTxtFile(fileId, fileName) {
            try {
                showMessage('info', 'Mengunduh file...');
                
                const formData = {
                    action: 'getTxtFile',
                    apiKey: API_KEY,
                    fileId: fileId
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.content) {
                        // Download file
                        const blob = new Blob([result.content], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        showMessage('success', '‚úÖ File berhasil diunduh');
                    } else {
                        showMessage('error', result.error || 'Gagal mengunduh file');
                    }
                } else {
                    showMessage('error', 'Gagal mengunduh file');
                }
            } catch (error) {
                console.error('Error downloading txt file:', error);
                showMessage('error', '‚ùå Gagal mengunduh file: ' + error.message);
            }
        }
        
        // ========== REPORT PARSING FUNCTION ==========
        function parseReportToForm(reportText) {
            try {
                const lines = reportText.split('\n');
                
                // Extract report date from first line
                const firstLine = lines[0];
                const dateMatch = firstLine.match(/Tanggal, (\d+) (\w+) (\d{4})/);
                if (dateMatch) {
                    const day = dateMatch[1];
                    const month = dateMatch[2];
                    const year = dateMatch[3];
                    
                    const months = {
                        'Januari': '01', 'Februari': '02', 'Maret': '03', 'April': '04',
                        'Mei': '05', 'Juni': '06', 'Juli': '07', 'Agustus': '08',
                        'September': '09', 'Oktober': '10', 'November': '11', 'Desember': '12'
                    };
                    
                    if (months[month]) {
                        const formattedDate = `${year}-${months[month]}-${day.padStart(2, '0')}`;
                        document.getElementById('reportDate').value = formattedDate;
                    }
                }
                
                // Cek format situasi
                let timeValue = 'pagi'; // default
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('Pagi :')) {
                        timeValue = 'pagi';
                        break;
                    } else if (lines[i].includes('Sore :')) {
                        timeValue = 'sore';
                        break;
                    } else if (lines[i].includes('Custom')) {
                        timeValue = 'custom';
                        // Extract custom time
                        const timeMatch = lines[i].match(/Custom (\d+\.\d+)/);
                        if (timeMatch) {
                            document.getElementById('reportTime').value = 'custom';
                            document.getElementById('reportTime').dataset.custom = timeMatch[1];
                            document.getElementById('customTimeContainer').style.display = 'block';
                            document.getElementById('customTime').value = timeMatch[1].replace('.', ':');
                        }
                        break;
                    }
                }
                
                if (timeValue !== 'custom') {
                    document.getElementById('reportTime').value = timeValue;
                }
                
                // Extract haljol
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('-Haljol :')) {
                        const haljolMatch = lines[i].match(/-Haljol : (.+)\./);
                        if (haljolMatch) {
                            document.getElementById('haljol').value = haljolMatch[1];
                        }
                        break;
                    }
                }
                
                // Extract data siap ops
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('1. Top DSPP :')) {
                        const topDsppMatch = lines[i].match(/1\. Top DSPP : (\d+)/);
                        if (topDsppMatch) document.getElementById('topDspp').value = topDsppMatch[1];
                    }
                    if (lines[i].includes('2. Nyata :')) {
                        const nyataMatch = lines[i].match(/2\. Nyata : (\d+)/);
                        if (nyataMatch) document.getElementById('nyata').value = nyataMatch[1];
                    }
                    if (lines[i].includes('3. Kurang :')) {
                        const kurangMatch = lines[i].match(/3\. Kurang : (\d+)/);
                        if (kurangMatch) document.getElementById('kurang').value = kurangMatch[1];
                    }
                    if (lines[i].includes('4. Siap Ops :')) {
                        const siapOpsMatch = lines[i].match(/4\. Siap Ops : (\d+)/);
                        if (siapOpsMatch) document.getElementById('siapOps').value = siapOpsMatch[1];
                    }
                }
                
                // Extract keterangan
                let keteranganStart = -1;
                let keteranganEnd = -1;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('5. Keterangan :')) {
                        keteranganStart = i + 1;
                    }
                    if (keteranganStart !== -1 && lines[i].includes('*III. Kegiatan :')) {
                        keteranganEnd = i;
                        break;
                    }
                }
                
                if (keteranganStart !== -1 && keteranganEnd !== -1) {
                    const keteranganLines = lines.slice(keteranganStart, keteranganEnd);
                    document.getElementById('keterangan').value = keteranganLines.join('\n').trim();
                }
                
                // Extract kegiatan
                let currentKegiatanType = '';
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('*1. Kegiatan Danramil :')) {
                        currentKegiatanType = 'danramil';
                        // Kosongkan container
                        document.getElementById('danramil-container').innerHTML = '';
                    } else if (lines[i].includes('*2. Kegiatan Koramil :')) {
                        currentKegiatanType = 'koramil';
                        document.getElementById('koramil-container').innerHTML = '';
                    } else if (lines[i].includes('*3. Kegiatan Babinsa :')) {
                        currentKegiatanType = 'babinsa';
                        document.getElementById('babinsa-container').innerHTML = '';
                    } else if (currentKegiatanType && lines[i].trim().startsWith('-')) {
                        const kegiatanText = lines[i].trim().substring(1).trim();
                        if (kegiatanText) {
                            // Tambahkan kegiatan item
                            const container = document.getElementById(`${currentKegiatanType}-container`);
                            const itemCount = container.querySelectorAll('.kegiatan-item').length;
                            const itemId = `${currentKegiatanType}-${itemCount}`;
                            
                            if (itemCount === 0) {
                                // Tambahkan item awal
                                addInitialKegiatanItem(currentKegiatanType);
                                const textarea = document.getElementById(`${currentKegiatanType}-0`);
                                if (textarea) {
                                    textarea.value = kegiatanText;
                                }
                            } else {
                                // Tambahkan item baru
                                addKegiatanItem(currentKegiatanType);
                                const textarea = document.getElementById(itemId);
                                if (textarea) {
                                    textarea.value = kegiatanText;
                                }
                            }
                        }
                    }
                }
                
                showMessage('success', '‚úÖ Data berhasil diekstrak dari laporan');
                
            } catch (error) {
                console.error('Error parsing report:', error);
                showMessage('warning', '‚ö†Ô∏è Tidak dapat mengekstrak semua data dari laporan');
            }
        }
        
        // ========== CLOUD DATA LOADING ==========
        async function showLoadFromCloudDialog() {
            showModal('cloudLoadModal');
            showMessage('info', 'Mengambil daftar laporan dari cloud...');
            
            try {
                const url = `${GOOGLE_SCRIPT_URL}?action=list&apiKey=${encodeURIComponent(API_KEY)}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const result = await response.json();
                    const cloudDataList = document.getElementById('cloudDataList');
                    
                    if (result.success && result.reports && result.reports.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">';
                        
                        result.reports.forEach((item, index) => {
                            const date = item.reportDate || '-';
                            const time = item.reportTime || '-';
                            
                            html += `
                                <div class="cloud-list-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #f8f9fa;">
                                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">
                                        ${date} - ${time}
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                        Haljol: ${item.haljol || 'Nihil'} | Siap Ops: ${item.siapOps || '0'}
                                    </div>
                                    <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                        ${item.timestamp ? new Date(item.timestamp).toLocaleDateString('id-ID') : ''}
                                    </div>
                                    <button onclick="loadSpecificCloudData('${date}', '${time}')" 
                                            style="background: var(--cloud); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%;">
                                        üìÇ Muat Data Ini
                                    </button>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        cloudDataList.innerHTML = html;
                        
                        showMessage('success', `‚úÖ ${result.reports.length} data ditemukan`);
                        
                    } else {
                        cloudDataList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Tidak ada data di cloud</p>';
                        showMessage('info', 'Tidak ada data tersimpan di cloud');
                    }
                } else {
                    document.getElementById('cloudDataList').innerHTML = 
                        '<p style="text-align: center; color: #e74c3c; padding: 20px;">Gagal mengambil data dari cloud</p>';
                    showMessage('error', 'Gagal menghubungi server cloud');
                }
            } catch (error) {
                console.error('Error loading cloud list:', error);
                document.getElementById('cloudDataList').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error: ' + error.message + '</p>';
                showMessage('error', 'Koneksi ke cloud gagal: ' + error.message);
            }
        }
        
        async function loadLastCloudData() {
            try {
                showMessage('info', 'Mengambil data terakhir dari cloud...');
                
                const url = `${GOOGLE_SCRIPT_URL}?action=last&apiKey=${encodeURIComponent(API_KEY)}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        await fillFormWithCloudData(result.data);
                        closeModal('cloudLoadModal');
                        showMessage('success', '‚úÖ Data terakhir berhasil dimuat dari cloud!');
                    } else {
                        showMessage('warning', result.error || 'Tidak ada data terakhir di cloud');
                    }
                } else {
                    showMessage('error', 'Gagal mengambil data: ' + response.status);
                }
            } catch (error) {
                console.error('Error loading last cloud data:', error);
                showMessage('error', '‚ùå Gagal memuat data terakhir dari cloud: ' + error.message);
            }
        }
        
        async function loadSpecificCloudData(date, time) {
            try {
                showMessage('info', 'Memuat data dari cloud...');
                
                const formData = {
                    action: 'getByDate',
                    apiKey: API_KEY,
                    date: date,
                    time: time
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        await fillFormWithCloudData(result.data);
                        closeModal('cloudLoadModal');
                        showMessage('success', '‚úÖ Data berhasil dimuat dari cloud!');
                    } else {
                        showMessage('warning', result.error || 'Data tidak ditemukan di cloud');
                    }
                } else {
                    showMessage('error', 'Gagal mengambil data spesifik');
                }
            } catch (error) {
                console.error('Error loading specific cloud data:', error);
                showMessage('error', '‚ùå Gagal memuat data dari cloud');
            }
        }
        
        async function fillFormWithCloudData(data) {
            if (data.reportDate) document.getElementById('reportDate').value = data.reportDate;
            
            if (data.reportTime) {
                // Konversi format waktu dari cloud ke pilihan dropdown
                if (data.reportTime === '04.00') {
                    document.getElementById('reportTime').value = 'pagi';
                } else if (data.reportTime === '16.00') {
                    document.getElementById('reportTime').value = 'sore';
                } else {
                    document.getElementById('reportTime').value = 'custom';
                    document.getElementById('reportTime').dataset.custom = data.reportTime;
                    document.getElementById('customTimeContainer').style.display = 'block';
                    document.getElementById('customTime').value = data.reportTime.replace('.', ':');
                }
            }
            
            if (data.haljol) document.getElementById('haljol').value = data.haljol;
            if (data.topDspp) document.getElementById('topDspp').value = data.topDspp;
            if (data.nyata) document.getElementById('nyata').value = data.nyata;
            if (data.kurang) document.getElementById('kurang').value = data.kurang;
            if (data.siapOps) document.getElementById('siapOps').value = data.siapOps;
            if (data.keterangan) document.getElementById('keterangan').value = data.keterangan;
            
            // Load kegiatan
            if (data.kegiatanDanramil) {
                const danramilContainer = document.getElementById('danramil-container');
                danramilContainer.innerHTML = '';
                
                const danramilItems = data.kegiatanDanramil.split(' || ').filter(item => item.trim());
                danramilItems.forEach((item, i) => {
                    if (i === 0) {
                        addInitialKegiatanItem('danramil');
                        const textarea = document.getElementById('danramil-0');
                        if (textarea) {
                            textarea.value = item.trim();
                        }
                    } else {
                        addKegiatanItem('danramil');
                        const textarea = document.getElementById(`danramil-${i}`);
                        if (textarea) {
                            textarea.value = item.trim();
                        }
                    }
                });
            } else {
                addInitialKegiatanItem('danramil');
            }
            
            if (data.kegiatanKoramil) {
                const koramilContainer = document.getElementById('koramil-container');
                koramilContainer.innerHTML = '';
                
                const koramilItems = data.kegiatanKoramil.split(' || ').filter(item => item.trim());
                koramilItems.forEach((item, i) => {
                    if (i === 0) {
                        addInitialKegiatanItem('koramil');
                        const textarea = document.getElementById('koramil-0');
                        if (textarea) {
                            textarea.value = item.trim();
                        }
                    } else {
                        addKegiatanItem('koramil');
                        const textarea = document.getElementById(`koramil-${i}`);
                        if (textarea) {
                            textarea.value = item.trim();
                        }
                    }
                });
            } else {
                addInitialKegiatanItem('koramil');
            }
            
            if (data.kegiatanBabinsa) {
                const babinsaContainer = document.getElementById('babinsa-container');
                babinsaContainer.innerHTML = '';
                
                const babinsaItems = data.kegiatanBabinsa.split(' || ').filter(item => item.trim());
                babinsaItems.forEach((item, i) => {
                    if (i === 0) {
                        addInitialKegiatanItem('babinsa');
                        const textarea = document.getElementById('babinsa-0');
                        if (textarea) {
                            textarea.value = item.trim();
                        }
                    } else {
                        addKegiatanItem('babinsa');
                        const textarea = document.getElementById(`babinsa-${i}`);
                        if (textarea) {
                            textarea.value = item.trim();
                        }
                    }
                });
            } else {
                addInitialKegiatanItem('babinsa');
            }
            
            setTimeout(() => {
                document.querySelectorAll('.auto-resize').forEach(textarea => {
                    autoResize(textarea);
                });
            }, 100);
            
            updateKurangFromKeterangan();
            generateReport();
        }
        
        // ========== OTHER FUNCTIONS ==========
        function sendToWhatsApp() {
            const reportText = document.getElementById('output').value;
            if (!reportText.trim()) {
                showMessage('error', 'Tidak ada laporan untuk dikirim');
                return;
            }
            
            const encodedText = encodeURIComponent(reportText);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            
            window.open(whatsappUrl, '_blank');
            showMessage('info', 'Membuka WhatsApp...');
        }
        
        function exportToTxt() {
            const reportText = document.getElementById('output').value;
            if (!reportText.trim()) {
                showMessage('error', 'Tidak ada laporan untuk diunduh');
                return;
            }
            
            const date = new Date(document.getElementById('reportDate').value);
            const timeSelect = document.getElementById('reportTime');
            const timeValue = timeSelect.value;
            const dateStr = date.toISOString().split('T')[0].replace(/-/g, '');
            const timeStr = timeValue === 'pagi' ? '0400' : 
                          timeValue === 'sore' ? '1600' : 
                          'custom';
            
            const filename = `LAPORAN_KORAMIL_${dateStr}_${timeStr}.txt`;
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('success', 'File TXT berhasil diunduh');
        }
        
        function resetForm() {
            if (confirm('Reset form? Semua data akan hilang.')) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').value = today;
                document.getElementById('reportTime').value = 'pagi';
                document.getElementById('haljol').value = 'Nihil';
                document.getElementById('topDspp').value = '25';
                document.getElementById('nyata').value = '19';
                document.getElementById('kurang').value = '0';
                document.getElementById('keterangan').value = '-DD : 0\n-BP : 0\n-Sakit : 0\n-Ijin : 0\n-Cuti : 0\n-Dinas Luar : 0';
                
                kegiatanTypes.forEach(type => {
                    const container = document.getElementById(`${type}-container`);
                    container.innerHTML = '';
                    addInitialKegiatanItem(type);
                });
                
                setTimeout(() => {
                    document.getElementById('koramil-0').value = '2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.';
                    document.getElementById('danramil-0').value = 'Melaksanakan monitoring perkembangan situasi dan kondisi wilayah Kecamatan Sukasada Kabupaten Buleleng.';
                    document.getElementById('babinsa-0').value = 'Melaksanakan pemantauan situasi wilayah desa binaan masing-masing.';
                    
                    document.querySelectorAll('.auto-resize').forEach(textarea => {
                        autoResize(textarea);
                    });
                }, 100);
                
                calculateSiapOps();
                updatePeriodeInfo();
                generateReport();
                showMessage('info', 'Form telah direset');
            }
        }
        
        function printReport() {
            const reportText = document.getElementById('output').value;
            if (!reportText.trim()) {
                showMessage('error', 'Tidak ada laporan untuk dicetak');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cetak Laporan Koramil</title>
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            line-height: 1.5; 
                            margin: 20px; 
                            white-space: pre-wrap; 
                        }
                        @media print {
                            body { margin: 10mm; }
                            @page { margin: 10mm; }
                        }
                        .header { text-align: center; margin-bottom: 20px; }
                        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>LAPORAN HARIAN KORAMIL 1609-05/SUKASADA</h2>
                        <p>${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                    <pre>${reportText}</pre>
                    <div class="footer">
                        <p>Dicetak dari Sistem PWA Koramil ‚Ä¢ ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
        
        // ========== INITIALIZATION ==========
        window.addEventListener('DOMContentLoaded', initForm);
        
    </script>
</body>
</html>
