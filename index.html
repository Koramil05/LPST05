<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Koramil 1609-05/Sukasada</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .main { grid-template-columns: 1fr; } }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        textarea { min-height: 100px; resize: vertical; }
        .data-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .data-item { text-align: center; }
        .data-item input { text-align: center; font-weight: bold; }
        .kegiatan-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .kegiatan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .kegiatan-title { font-weight: bold; color: #2c3e50; }
        .add-btn { background: #27ae60; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .remove-btn { background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .preview-box { background: #000; color: #fff; font-family: monospace; padding: 15px; border-radius: 5px; min-height: 400px; white-space: pre-wrap; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-save { background: #3498db; color: white; }
        .btn-send { background: #25D366; color: white; }
        .btn-reset { background: #e74c3c; color: white; }
        .btn-export { background: #95a5a6; color: white; }
        .message { padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LAPORAN HARIAN KORAMIL 1609-05/SUKASADA</h1>
            <p>Jl. Jelantik Gingsir 32 Sukasada Bali</p>
        </div>
        
        <div class="main">
            <!-- FORM INPUT -->
            <div class="panel">
                <h2>üìù INPUT DATA LAPORAN</h2>
                
                <div class="form-group">
                    <label>Tanggal Laporan</label>
                    <input type="date" id="reportDate" onchange="generateReport()">
                </div>
                
                <div class="form-group">
                    <label>Waktu Laporan</label>
                    <select id="reportTime" onchange="generateReport()">
                        <option value="04.00">Pagi (04.00 WITA)</option>
                        <option value="16.00">Sore (16.00 WITA)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Haljol</label>
                    <input type="text" id="haljol" value="Nihil" oninput="generateReport()">
                </div>
                
                <div class="data-grid">
                    <div class="data-item">
                        <label>Top DSPP</label>
                        <input type="number" id="topDspp" value="25" oninput="calculateSiapOps()">
                    </div>
                    <div class="data-item">
                        <label>Nyata</label>
                        <input type="number" id="nyata" value="19" oninput="calculateSiapOps()">
                    </div>
                    <div class="data-item">
                        <label>Kurang</label>
                        <input type="number" id="kurang" value="0" oninput="calculateSiapOps()">
                    </div>
                    <div class="data-item">
                        <label>Siap Ops</label>
                        <input type="number" id="siapOps" value="19" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Keterangan</label>
                    <textarea id="keterangan" oninput="updateKurang(); generateReport()">-DD : 0
-BP : 0
-Sakit : 0
-Ijin : 0
-Cuti : 0
-Dinas Luar : 0</textarea>
                </div>
                
                <!-- KEGIATAN -->
                <div class="form-group">
                    <label>Kegiatan</label>
                    
                    <div class="kegiatan-box">
                        <div class="kegiatan-header">
                            <div class="kegiatan-title">Danramil</div>
                            <button class="add-btn" onclick="addKegiatan('danramil')">+</button>
                        </div>
                        <div id="danramil-container">
                            <textarea placeholder="Kegiatan Danramil..." oninput="generateReport()"></textarea>
                        </div>
                    </div>
                    
                    <div class="kegiatan-box">
                        <div class="kegiatan-header">
                            <div class="kegiatan-title">Koramil</div>
                            <button class="add-btn" onclick="addKegiatan('koramil')">+</button>
                        </div>
                        <div id="koramil-container">
                            <textarea placeholder="Kegiatan Koramil..." oninput="generateReport()">2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.</textarea>
                        </div>
                    </div>
                    
                    <div class="kegiatan-box">
                        <div class="kegiatan-header">
                            <div class="kegiatan-title">Babinsa</div>
                            <button class="add-btn" onclick="addKegiatan('babinsa')">+</button>
                        </div>
                        <div id="babinsa-container">
                            <textarea placeholder="Kegiatan Babinsa..." oninput="generateReport()">Melaksanakan pemantauan dan pendataan situasi wilayah desa binaan masing-masing.</textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PREVIEW -->
            <div class="panel">
                <h2>üëÅÔ∏è PREVIEW LAPORAN</h2>
                
                <div id="message" class="message"></div>
                
                <div class="preview-box" id="output">
                    Laporan akan muncul di sini...
                </div>
                
                <div class="buttons">
                    <button class="btn btn-save" onclick="saveToCloud()">
                        üíæ SIMPAN KE CLOUD
                    </button>
                    <button class="btn btn-send" onclick="sendToWhatsApp()">
                        üì± KIRIM KE WHATSAPP
                    </button>
                    <button class="btn btn-export" onclick="exportToTxt()">
                        üì• DOWNLOAD TXT
                    </button>
                    <button class="btn btn-reset" onclick="resetForm()">
                        üîÑ RESET FORM
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdlvQbwCCB8e0RP0mGm9_2ucBTQN5-WMpGaJYtVf9cI8PutWdMH0DpypAkqnT7yymOBQ/exec';
        const API_KEY = 'koramil2024@secure';
        
        // INITIALIZE
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            
            // Generate initial report
            generateReport();
            
            // Test connection
            setTimeout(testConnection, 1000);
        });
        
        // TEST CONNECTION
        async function testConnection() {
            try {
                const url = `${GOOGLE_SCRIPT_URL}?action=test&apiKey=${encodeURIComponent(API_KEY)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Terhubung ke server cloud', 'success');
                } else {
                    showMessage('‚ö†Ô∏è Server error: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Tidak bisa terhubung ke server', 'error');
            }
        }
        
        // CALCULATIONS
        function calculateSiapOps() {
            const nyata = parseInt(document.getElementById('nyata').value) || 0;
            const kurang = parseInt(document.getElementById('kurang').value) || 0;
            document.getElementById('siapOps').value = nyata - kurang;
            generateReport();
        }
        
        function updateKurang() {
            const keterangan = document.getElementById('keterangan').value;
            const lines = keterangan.split('\n');
            let total = 0;
            
            lines.forEach(line => {
                if (line.includes(':')) {
                    const value = parseInt(line.split(':')[1]) || 0;
                    total += value;
                }
            });
            
            document.getElementById('kurang').value = total;
            calculateSiapOps();
        }
        
        // KEGIATAN FUNCTIONS
        function addKegiatan(type) {
            const container = document.getElementById(`${type}-container`);
            const textarea = document.createElement('textarea');
            textarea.placeholder = `Kegiatan ${type} tambahan...`;
            textarea.oninput = generateReport;
            
            const div = document.createElement('div');
            div.style.position = 'relative';
            div.style.marginTop = '5px';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '-';
            removeBtn.style.position = 'absolute';
            removeBtn.style.right = '5px';
            removeBtn.style.top = '5px';
            removeBtn.onclick = function() {
                div.remove();
                generateReport();
            };
            
            div.appendChild(textarea);
            div.appendChild(removeBtn);
            container.appendChild(div);
        }
        
        // GENERATE REPORT
        function generateReport() {
            try {
                const date = document.getElementById('reportDate').value;
                if (!date) return;
                
                const dateObj = new Date(date);
                const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][dateObj.getDay()];
                const tanggal = dateObj.getDate();
                const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][dateObj.getMonth()];
                const tahun = dateObj.getFullYear();
                
                const time = document.getElementById('reportTime').value;
                const haljol = document.getElementById('haljol').value;
                const topDspp = document.getElementById('topDspp').value;
                const nyata = document.getElementById('nyata').value;
                const kurang = document.getElementById('kurang').value;
                const siapOps = document.getElementById('siapOps').value;
                const keterangan = document.getElementById('keterangan').value;
                
                // Get kegiatan
                function getKegiatan(type) {
                    const container = document.getElementById(`${type}-container`);
                    const textareas = container.querySelectorAll('textarea');
                    const items = [];
                    textareas.forEach(ta => {
                        if (ta.value.trim()) items.push(ta.value.trim());
                    });
                    return items.length > 0 ? items : [`Melaksanakan kegiatan ${type}`];
                }
                
                const waktuSalam = time === '04.00' ? 'Pagi' : 'Sore';
                
                let report = `Perihal : Laporan perkembangan situasi Koramil 1609-05/Sukasada Hari ${hari} Tanggal, ${tanggal} ${bulan} ${tahun}.\n\n`;
                report += `Yth. Komandan Kodim 1609/Buleleng.\n`;
                report += `Cc. Kasdim 1609/Buleleng.\n\n`;
                report += `Selamat ${waktuSalam}, Mohon ijin melaporkan Situasi Satuan Koramil 1609-05/Sukasada Hari ${hari} Tanggal, ${tanggal} ${bulan} ${tahun} Pukul ${time} Wita dalam rangka kegiatan Pembinaan Kekuatan Satuan Bulan ${bulan} tahun ${tahun} sebagai berikut :\n\n`;
                report += `*I. Situasi dan Haljol :*\n\n`;
                report += `${waktuSalam} :\n`;
                report += `-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${hari} Tanggal ${tanggal} ${bulan} ${tahun} Pukul ${time} Wita dalam keadaan Aman dan Kondusif\n\n`;
                report += `-Haljol : ${haljol}.\n\n`;
                report += `*II. Data Siap Ops :*\n\n`;
                report += `1. Top DSPP : ${topDspp}\n`;
                report += `2. Nyata : ${nyata}\n`;
                report += `3. Kurang : ${kurang}\n`;
                report += `4. Siap Ops : ${siapOps}\n\n`;
                report += `5. Keterangan :\n\n${keterangan}\n\n`;
                report += `*III. Kegiatan :*\n\n`;
                report += `*1. Kegiatan Danramil :*\n\n`;
                getKegiatan('danramil').forEach(item => report += `-${item}\n`);
                report += `\n*2. Kegiatan Koramil :*\n\n`;
                getKegiatan('koramil').forEach(item => report += `-${item}\n`);
                report += `\n*3. Kegiatan Babinsa :*\n\n`;
                getKegiatan('babinsa').forEach(item => report += `-${item}\n`);
                report += `\n*DEMIKIAN MMP.*\n`;
                report += `Dokumentasi terlampir.`;
                
                document.getElementById('output').textContent = report;
                
            } catch (error) {
                console.error('Generate error:', error);
            }
        }
        
        // SAVE TO CLOUD
        async function saveToCloud() {
            const reportText = document.getElementById('output').textContent;
            
            if (!document.getElementById('reportDate').value) {
                showMessage('‚ùå Isi tanggal laporan terlebih dahulu', 'error');
                return;
            }
            
            try {
                showMessage('‚è≥ Menyimpan ke cloud...', 'info');
                
                const formData = {
                    action: 'save',
                    apiKey: API_KEY,
                    reportDate: document.getElementById('reportDate').value,
                    reportTime: document.getElementById('reportTime').value,
                    haljol: document.getElementById('haljol').value,
                    topDspp: document.getElementById('topDspp').value,
                    nyata: document.getElementById('nyata').value,
                    kurang: document.getElementById('kurang').value,
                    siapOps: document.getElementById('siapOps').value,
                    keterangan: document.getElementById('keterangan').value,
                    kegiatanDanramil: getKegiatanText('danramil'),
                    kegiatanKoramil: getKegiatanText('koramil'),
                    kegiatanBabinsa: getKegiatanText('babinsa'),
                    fullReport: reportText
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Data berhasil disimpan ke Google Sheets', 'success');
                    
                    // Also save to Drive
                    const date = document.getElementById('reportDate').value.replace(/-/g, '');
                    const time = document.getElementById('reportTime').value.replace('.', '');
                    const filename = `LAPORAN_KORAMIL_${date}_${time}.txt`;
                    
                    const driveData = {
                        action: 'uploadtxttodrive',
                        apiKey: API_KEY,
                        filename: filename,
                        content: reportText
                    };
                    
                    const driveResponse = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(driveData)
                    });
                    
                    const driveResult = await driveResponse.json();
                    if (driveResult.success) {
                        showMessage('‚úÖ Juga disimpan ke Google Drive', 'success');
                    }
                    
                } else {
                    showMessage('‚ùå Gagal: ' + result.error, 'error');
                }
                
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // GET KEGIATAN TEXT
        function getKegiatanText(type) {
            const container = document.getElementById(`${type}-container`);
            const textareas = container.querySelectorAll('textarea');
            const items = [];
            textareas.forEach(ta => {
                if (ta.value.trim()) items.push(ta.value.trim());
            });
            return items.join(' | ');
        }
        
        // SEND TO WHATSAPP
        function sendToWhatsApp() {
            const reportText = document.getElementById('output').textContent;
            if (!reportText || reportText === 'Laporan akan muncul di sini...') {
                showMessage('‚ùå Buat laporan dulu', 'error');
                return;
            }
            
            const encodedText = encodeURIComponent(reportText);
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
            showMessage('üì± Membuka WhatsApp...', 'info');
        }
        
        // EXPORT TO TXT
        function exportToTxt() {
            const reportText = document.getElementById('output').textContent;
            if (!reportText || reportText === 'Laporan akan muncul di sini...') {
                showMessage('‚ùå Buat laporan dulu', 'error');
                return;
            }
            
            const date = document.getElementById('reportDate').value.replace(/-/g, '');
            const time = document.getElementById('reportTime').value.replace('.', '');
            const filename = `LAPORAN_KORAMIL_${date}_${time}.txt`;
            
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('‚úÖ File TXT berhasil diunduh', 'success');
        }
        
        // RESET FORM
        function resetForm() {
            if (confirm('Reset form? Data akan hilang.')) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').value = today;
                document.getElementById('reportTime').value = '04.00';
                document.getElementById('haljol').value = 'Nihil';
                document.getElementById('topDspp').value = '25';
                document.getElementById('nyata').value = '19';
                document.getElementById('kurang').value = '0';
                document.getElementById('keterangan').value = '-DD : 0\n-BP : 0\n-Sakit : 0\n-Ijin : 0\n-Cuti : 0\n-Dinas Luar : 0';
                
                // Reset kegiatan
                ['danramil', 'koramil', 'babinsa'].forEach(type => {
                    const container = document.getElementById(`${type}-container`);
                    const firstTextarea = container.querySelector('textarea');
                    container.innerHTML = '';
                    const newTextarea = document.createElement('textarea');
                    newTextarea.placeholder = `Kegiatan ${type}...`;
                    newTextarea.oninput = generateReport;
                    
                    if (type === 'koramil') {
                        newTextarea.value = '2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.';
                    } else if (type === 'danramil') {
                        newTextarea.value = 'Melaksanakan monitoring perkembangan situasi dan kondisi wilayah Kecamatan Sukasada Kabupaten Buleleng.';
                    } else if (type === 'babinsa') {
                        newTextarea.value = 'Melaksanakan pemantauan dan pendataan situasi wilayah desa binaan masing-masing.';
                    }
                    
                    container.appendChild(newTextarea);
                });
                
                generateReport();
                showMessage('üîÑ Form telah direset', 'info');
            }
        }
        
        // SHOW MESSAGE
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
