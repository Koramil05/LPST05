<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Koramil - Fixed Version</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { 
            width: 100%; 
            padding: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        textarea { min-height: 100px; }
        button { 
            padding: 10px 20px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
        }
        button:hover { background: #45a049; }
        .message { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Laporan Koramil 1609-05/Sukasada</h1>
        
        <div id="messageContainer"></div>
        
        <div class="form-group">
            <label>Tanggal Laporan:</label>
            <input type="date" id="reportDate">
        </div>
        
        <div class="form-group">
            <label>Waktu Laporan:</label>
            <select id="reportTime">
                <option value="04.00">04.00 WITA</option>
                <option value="16.00">16.00 WITA</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Haljol:</label>
            <input type="text" id="haljol" value="Nihil">
        </div>
        
        <div class="form-group">
            <label>Keterangan:</label>
            <textarea id="keterangan">-DD : 0
-BP : 0</textarea>
        </div>
        
        <div class="form-group">
            <label>Laporan Lengkap:</label>
            <textarea id="fullReport" placeholder="Laporan akan digenerate otomatis..."></textarea>
        </div>
        
        <div>
            <button onclick="generateReport()">Generate Laporan</button>
            <button onclick="saveToCloud()" style="background: #2196F3;">Simpan ke Cloud</button>
            <button onclick="loadFromCloud()" style="background: #FF9800;">Panggil Data</button>
            <button onclick="testConnection()" style="background: #9C27B0;">Test Koneksi</button>
        </div>
        
        <div id="cloudData" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; display: none;">
            <h3>Data dari Cloud:</h3>
            <div id="cloudDataContent"></div>
        </div>
    </div>

    <script>
        // CONFIG - PASTIKAN INI BENAR
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz9Gy5TsJ3V4AzMdz-Y3SeJk443YFHfQ5pbPUzVj8Mym0vTW5kIzBi73tZRZbsc7hdSMA/exec';
        const API_KEY = 'koramil2024@secure';
        
        // Show message
        function showMessage(type, text) {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = text;
            container.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }
        
        // Generate report
        function generateReport() {
            const date = document.getElementById('reportDate').value;
            const time = document.getElementById('reportTime').value;
            const haljol = document.getElementById('haljol').value;
            
            if (!date) {
                showMessage('error', 'Harap isi tanggal laporan');
                return;
            }
            
            const reportDate = new Date(date);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const hari = days[reportDate.getDay()];
            const tanggal = reportDate.getDate();
            const bulan = months[reportDate.getMonth()];
            const tahun = reportDate.getFullYear();
            
            let situasi = '';
            if (time === '04.00') {
                situasi = `-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${hari} Tanggal ${tanggal} ${bulan} ${tahun} Pukul 16.00 Wita s.d Pukul 04.00 Wita dalam keadaan Aman dan Kondusif`;
            } else {
                situasi = `-Situasi : Situasi Wilayah Koramil 1609-05/Sukasada Pada Hari ${hari} Tanggal ${tanggal} ${bulan} ${tahun} Pukul 04.00 Wita s.d Pukul 16.00 Wita dalam keadaan Aman dan Kondusif`;
            }
            
            const report = `Perihal : Laporan perkembangan situasi Koramil 1609-05/Sukasada Hari ${hari} Tanggal, ${tanggal} ${bulan} ${tahun}.\n\n` +
                          `Yth. Komandan Kodim 1609/Buleleng.\n` +
                          `Cc. Kasdim 1609/Buleleng.\n\n` +
                          `Selamat Pagi, Mohon ijin melaporkan Situasi Satuan Koramil 1609-05/Sukasada Hari ${hari} Tanggal, ${tanggal} ${bulan} ${tahun} Pukul ${time} Wita dalam rangka kegiatan Pembinaan Kekuatan Satuan Bulan ${bulan} tahun ${tahun} sebagai berikut :\n\n` +
                          `*I. Situasi dan Haljol :*\n\n` +
                          `${situasi}\n\n` +
                          `-Haljol : ${haljol}.\n\n` +
                          `*II. Data Siap Ops :*\n\n` +
                          `1. Top DSPP : 25\n` +
                          `2. Nyata : 19\n` +
                          `3. Kurang : 9\n` +
                          `4. Siap Ops : 10\n\n` +
                          `5. Keterangan :\n\n` +
                          document.getElementById('keterangan').value + `\n\n` +
                          `*III. Kegiatan :*\n\n` +
                          `*1. Kegiatan Danramil :*\n\n` +
                          `-Melaksanakan monitoring perkembangan situasi dan kondisi wilayah Kecamatan Sukasada Kabupaten Buleleng.\n\n` +
                          `*2. Kegiatan Koramil :*\n\n` +
                          `2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.\n\n` +
                          `*3. Kegiatan Babinsa :*\n\n` +
                          `-Melaksanakan pemantauan dan pendataan situasi wilayah desa binaan masing-masing.\n\n` +
                          `*DEMIKIAN MMP.*\n` +
                          `Dokumentasi terlampir.`;
            
            document.getElementById('fullReport').value = report;
            showMessage('success', 'Laporan berhasil digenerate');
        }
        
        // Test connection
        async function testConnection() {
            showMessage('info', 'Menguji koneksi ke server...');
            
            try {
                const url = `${GOOGLE_SCRIPT_URL}?action=test&apiKey=${encodeURIComponent(API_KEY)}`;
                console.log('Testing URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.success) {
                    showMessage('success', '✅ Koneksi ke server BERHASIL!');
                } else {
                    showMessage('error', `❌ Koneksi gagal: ${result.error}`);
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showMessage('error', `❌ Error: ${error.message}`);
            }
        }
        
        // Save to cloud
        async function saveToCloud() {
            const reportText = document.getElementById('fullReport').value;
            
            if (!reportText) {
                showMessage('error', 'Harap generate laporan terlebih dahulu');
                return;
            }
            
            if (!document.getElementById('reportDate').value) {
                showMessage('error', 'Harap isi tanggal laporan');
                return;
            }
            
            showMessage('info', 'Menyimpan ke cloud...');
            
            const formData = {
                action: 'save',
                apiKey: API_KEY,
                reportDate: document.getElementById('reportDate').value,
                reportTime: document.getElementById('reportTime').value,
                haljol: document.getElementById('haljol').value,
                topDspp: '25',
                nyata: '19',
                kurang: '9',
                siapOps: '10',
                keterangan: document.getElementById('keterangan').value,
                kegiatanDanramil: 'Melaksanakan monitoring perkembangan situasi dan kondisi wilayah Kecamatan Sukasada Kabupaten Buleleng.',
                kegiatanKoramil: '2 orang anggota melaksanakan dinas dalam, jaga pangkalan Koramil 1609-05/Sukasada.',
                kegiatanBabinsa: 'Melaksanakan pemantauan dan pendataan situasi wilayah desa binaan masing-masing.',
                fullReport: reportText,
                source: 'Web App',
                username: 'Operator'
            };
            
            console.log('Sending data:', formData);
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Save response status:', response.status);
                
                const result = await response.json();
                console.log('Save result:', result);
                
                if (result.success) {
                    showMessage('success', `✅ ${result.message}<br>ID: ${result.reportId}`);
                } else {
                    showMessage('error', `❌ Gagal: ${result.error}<br>${result.message || ''}`);
                }
            } catch (error) {
                console.error('Save error:', error);
                showMessage('error', `❌ Error: ${error.message}`);
            }
        }
        
        // Load from cloud
        async function loadFromCloud() {
            showMessage('info', 'Memuat data dari cloud...');
            
            try {
                const url = `${GOOGLE_SCRIPT_URL}?action=list&apiKey=${encodeURIComponent(API_KEY)}`;
                console.log('Load URL:', url);
                
                const response = await fetch(url);
                console.log('Load response status:', response.status);
                
                const result = await response.json();
                console.log('Load result:', result);
                
                if (result.success) {
                    const container = document.getElementById('cloudData');
                    const content = document.getElementById('cloudDataContent');
                    
                    container.style.display = 'block';
                    
                    if (result.reports && result.reports.length > 0) {
                        let html = `<p>Ditemukan ${result.reports.length} laporan:</p><ul>`;
                        
                        result.reports.forEach((report, index) => {
                            html += `<li>
                                <strong>${report.reportDate} - ${report.reportTime}</strong><br>
                                Haljol: ${report.haljol}<br>
                                <button onclick="loadSpecificReport('${report.reportDate}', '${report.reportTime}')" style="font-size: 12px; padding: 3px 8px;">
                                    Muat Data Ini
                                </button>
                            </li>`;
                        });
                        
                        html += '</ul>';
                        content.innerHTML = html;
                        
                        showMessage('success', `✅ ${result.reports.length} data ditemukan`);
                    } else {
                        content.innerHTML = '<p>Tidak ada data di cloud</p>';
                        showMessage('info', 'Tidak ada data di cloud');
                    }
                } else {
                    showMessage('error', `❌ Gagal memuat: ${result.error}`);
                }
            } catch (error) {
                console.error('Load error:', error);
                showMessage('error', `❌ Error: ${error.message}`);
            }
        }
        
        // Load specific report
        async function loadSpecificReport(date, time) {
            showMessage('info', `Memuat data ${date} ${time}...`);
            
            const formData = {
                action: 'getByDate',
                apiKey: API_KEY,
                date: date,
                time: time
            };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Fill the form with data
                    document.getElementById('reportDate').value = result.data.reportDate;
                    document.getElementById('reportTime').value = result.data.reportTime;
                    document.getElementById('haljol').value = result.data.haljol;
                    document.getElementById('keterangan').value = result.data.keterangan;
                    document.getElementById('fullReport').value = result.data.fullReport;
                    
                    document.getElementById('cloudData').style.display = 'none';
                    showMessage('success', '✅ Data berhasil dimuat dari cloud');
                } else {
                    showMessage('error', `❌ Gagal memuat data spesifik: ${result.error}`);
                }
            } catch (error) {
                console.error('Load specific error:', error);
                showMessage('error', `❌ Error: ${error.message}`);
            }
        }
        
        // Initialize
        window.onload = function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            
            // Test connection on load
            setTimeout(() => {
                testConnection();
            }, 1000);
        };
    </script>
</body>
</html>